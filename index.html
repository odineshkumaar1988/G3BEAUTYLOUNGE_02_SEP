<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice Generator - G3 BEAUTY LOUNGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#e67e22">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #e67e22;
      --success: #27ae60;
      --info: #3498db;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #34495e;
      --bg: #f8fafc;
      --white: #ffffff;
      --border: #dee2e6;
      --shadow: 0 2px 15px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
    }

    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, var(--bg) 0%, #e8f4f8 100%);
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--primary);
      line-height: 1.6;
      font-size: 14px;
    }

    .main-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .form-section {
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .preview-section {
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 20px;
      position: sticky;
      top: 20px;
      height: fit-content;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .section-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
      color: var(--white);
      padding: 15px 20px;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-content {
      padding: 20px;
    }

    .section-title {
      color: var(--accent);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 5px;
    }

    .form-grid {
      display: grid;
      gap: 15px;
    }

    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--dark);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    input, select, textarea {
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: var(--white);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.1);
    }
	
	/* ===== DELTA: Invoice Items Section - Increased Font Size ===== */
        .invoice-items input[type="text"],
        .invoice-items input[type="number"] {
            font-size: 12px !important; /* CHANGED: Increased from 14px to 16px (2-point increase) */
            height: 30px !important; /* CHANGED: Increased height for better visibility */
            padding: 15px;
        }

    textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }

    /* Master Loading Section */
    .master-section {
      background: linear-gradient(135deg, var(--light) 0%, #d5dbdb 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .master-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .master-card {
      background: var(--white);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    /* Customer Form */
    .customer-form {
      background: linear-gradient(135deg, #fff9e6 0%, #fef5e7 100%);
      padding: 15px;
      border-radius: 8px;
      border: 2px solid var(--warning);
      margin-bottom: 20px;
    }

    /* Enhanced Search Box with Clear Button */
    .search-box {
      background: linear-gradient(135deg, #e8f8ff 0%, #e1f5fe 100%);
      padding: 15px;
      border-radius: 8px;
      border: 2px solid var(--info);
      margin-bottom: 15px;
    }

    .search-container {
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid var(--info);
      border-radius: 8px;
      font-size: 14px;
      background: var(--white);
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .clear-search-btn {
      background: var(--danger);
      color: var(--white);
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .clear-search-btn:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }

    .show-all-btn {
      background: var(--success);
      color: var(--white);
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .show-all-btn:hover {
      background: #1e8449;
      transform: translateY(-1px);
    }

    /* LOV Dropdown */
    .lov-dropdown {
      position: relative;
      max-height: 200px;
      overflow-y: auto;
      background: var(--white);
      border: 2px solid var(--info);
      border-radius: 8px;
      margin-top: 10px;
      box-shadow: var(--shadow);
    }

    .lov-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      transition: background-color 0.2s ease;
    }

    .lov-item:hover {
      background-color: #f8f9fa;
    }

    .lov-item:last-child {
      border-bottom: none;
    }

    .lov-item.selected {
      background-color: var(--info);
      color: var(--white);
    }

    .no-results {
      padding: 15px;
      text-align: center;
      color: #666;
      font-style: italic;
    }

    /* Client Name Select Enhancement */
    .client-name-container {
      position: relative;
    }

    .client-name-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: var(--white);
      border: 2px solid var(--info);
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      display: none;
    }

    .client-name-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      transition: background-color 0.2s ease;
    }

    .client-name-item:hover {
      background-color: #f8f9fa;
    }

    .client-name-item:last-child {
      border-bottom: none;
    }

    .client-name-item.selected {
      background-color: var(--accent);
      color: var(--white);
    }

    /* Button Styles */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }

    .btn {
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      min-height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #d68910 100%);
      color: var(--white);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
      color: var(--white);
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #229954 100%);
      color: var(--white);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
      color: var(--white);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
      color: var(--white);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
      color: var(--white);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 11px;
      min-height: 32px;
    }

    /* Invoice Items Table */
    .table-container {
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin: 15px 0;
    }

    .invoice-items {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .invoice-items th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
      color: var(--white);
      padding: 12px 8px;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .invoice-items td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    .invoice-items .desc-cell {
      text-align: left;
      word-wrap: break-word;
      white-space: normal;
      width: auto;
      max-width: 0;
    }

    .invoice-items .qty-cell {
      width: 75px;
      text-align: right;
      white-space: nowrap;
    }

    .invoice-items .unit-cell {
      width: 90px;
      text-align: right;
      white-space: nowrap;
    }

    .invoice-items .total-cell {
      width: 120px;
      text-align: right;
      white-space: nowrap;
    }

    .invoice-items .action-cell {
      width: 60px;
      text-align: center;
    }

    .invoice-items input {
      border: 1px solid var(--border);
      padding: 4px;
      border-radius: 4px;
      font-size: 12px;
    }

    .invoice-items .qty-input {
      width: 75px;
      text-align: left;
    }

    .invoice-items .unit-input {
      width: 90px;
      text-align: left;
    }

    .invoice-items select {
      width: 100%;
      border: 1px solid var(--border);
      padding: 4px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Summary Section */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
      margin-top: 15px;
    }

    .summary-card {
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .total-display {
      background: linear-gradient(135deg, var(--accent) 0%, #d68910 100%);
      color: var(--white);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      margin-top: 10px;
    }

    /* Preview Section */
    .invoice-preview {
      background: var(--white);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    .preview-header {
      color: var(--accent);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
	
	#previewBox {
    background-color: #ffffff !important;
    color: #000000 !important;
    display: block !important;
    visibility: visible !important;
    position: relative !important;
    min-height: 400px;
    padding: 20px;
    border: 1px solid #ddd;
	}

	#previewBox * {
    background-color: transparent !important;
    color: inherit !important;
	}

    /* Status Cards */
    .status-card {
      background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
      color: var(--white);
      padding: 12px 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 12px;
      font-weight: 600;
    }

    /* Compact History Lists - Single Row Layout */
    .history-list {
      list-style: none;
      padding: 0;
    }

    .history-item {
      background: var(--white);
      margin-bottom: 8px;
      padding: 12px 15px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .history-item-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .history-item-number {
      color: var(--accent);
      font-weight: 700;
      font-size: 14px;
      min-width: 80px;
    }

    .history-item-details {
      color: var(--primary);
      font-size: 12px;
    }

    .history-actions {
      display: flex;
      gap: 8px;
    }

    .history-actions .btn {
      padding: 6px 10px;
      font-size: 10px;
      min-height: 30px;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .preview-section {
        position: static;
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      .form-grid.grid-2,
      .form-grid.grid-3,
      .form-grid.grid-4 {
        grid-template-columns: 1fr;
      }

      .master-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .history-item-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .history-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* Animation */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Print Styles */
    @media print {
      .main-container {
        grid-template-columns: 1fr;
      }
      
      .form-section {
        display: none;
      }
      
      .preview-section {
        box-shadow: none;
        border: none;
      }
    }

	  /* Mobile Responsive Enhancements */
@media only screen and (max-width: 768px) {
  /* Adjust body and container */
  .container {
    padding: 10px !important;
    margin: 0 !important;
  }

  /* Make sections stack properly on mobile */
  .section {
    padding: 15px 10px !important;
    margin-bottom: 15px !important;
  }

  /* Responsive form inputs */
  input[type="text"], 
  input[type="number"], 
  input[type="email"], 
  input[type="tel"], 
  select, 
  textarea {
    width: 100% !important;
    font-size: 16px !important; /* Prevents zoom on iOS */
    padding: 10px !important;
    margin-bottom: 10px !important;
    box-sizing: border-box !important;
  }

  /* Stack form fields vertically */
  .form-row {
    flex-direction: column !important;
  }

  /* Responsive buttons */
  button {
    width: 100% !important;
    padding: 12px !important;
    margin: 5px 0 !important;
    font-size: 14px !important;
    touch-action: manipulation;
  }

  /* Action buttons container */
  .section button {
    margin: 5px 0 !important;
    display: block !important;
  }

  /* Responsive tables */
  table {
    width: 100% !important;
    font-size: 12px !important;
  }

  /* Stack table content on very small screens */
  @media only screen and (max-width: 480px) {
    table, thead, tbody, th, td, tr {
      display: block !important;
    }
    
    thead tr {
      position: absolute !important;
      top: -9999px !important;
      left: -9999px !important;
    }
    
    tr {
      border: 1px solid #ccc !important;
      margin-bottom: 10px !important;
      padding: 10px !important;
    }
    
    td {
      border: none !important;
      position: relative !important;
      padding-left: 50% !important;
      text-align: left !important;
    }
    
    td:before {
      content: attr(data-label) ": " !important;
      position: absolute !important;
      left: 6px !important;
      width: 45% !important;
      padding-right: 10px !important;
      white-space: nowrap !important;
      font-weight: bold !important;
    }
  }

  /* Preview area responsive */
  #previewArea {
    padding: 10px !important;
    font-size: 12px !important;
    overflow-x: auto !important;
  }

  /* Text areas */
  textarea {
    min-height: 80px !important;
    resize: vertical !important;
  }

  /* Currency selector */
  select[name="currency"] {
    width: auto !important;
    min-width: 100px !important;
  }

  /* File upload button */
  input[type="file"] {
    width: 100% !important;
    padding: 8px !important;
  }

  /* Customer search section */
  .customer-search {
    flex-direction: column !important;
  }

  /* Ensure proper touch targets */
  button, input, select, textarea, label {
    min-height: 44px !important;
  }

  /* Hide less important elements on very small screens if needed */
  @media only screen and (max-width: 320px) {
    .emoji {
      display: none !important;
    }
  }
}

/* Tablet adjustments */
@media only screen and (min-width: 769px) and (max-width: 1024px) {
  .container {
    padding: 20px !important;
  }
  
  input[type="text"], 
  input[type="number"], 
  input[type="email"], 
  input[type="tel"], 
  select, 
  textarea {
    font-size: 15px !important;
  }
}

/* Ensure touch-friendly interface */
@media (hover: none) and (pointer: coarse) {
  button:hover {
    background-color: inherit !important;
  }
  
  button:active {
    transform: scale(0.98) !important;
  }
}

  </style>
</head>
<body>
  <div class="main-container">
    <!-- FORM SECTION -->
    <div class="form-section">
      <div class="section-header">
        üßæ Invoice Generator - G3 Beauty Lounge
      </div>
      
      <div class="section-content">
        <!-- MASTER DATA LOADING -->
        <div class="master-section">
          <div class="section-title">üìä Master Data Management</div>
          <div class="master-grid">
            <div class="master-card">
              <label>üì¶ Items Master CSV</label>
              <input type="file" id="itemCsvInput" accept=".csv" style="margin-bottom: 10px;"/>
              <div class="btn-group">
                <button class="btn btn-info btn-sm" onclick="loadItemsMaster()">Load Items</button>
              </div>
              <span class="print-note" id="masterStatus">No items loaded</span>
            </div>
            
            <div class="master-card">
              <label>üë• Customer Master CSV</label>
              <input type="file" id="customerCsvInput" accept=".csv" style="margin-bottom: 10px;"/>
              <div class="btn-group">
                <button class="btn btn-info btn-sm" onclick="loadCustomersMaster()">Load Customers</button>
              </div>
              <span class="print-note" id="customerMasterStatus">No customers loaded</span>
            </div>
          </div>
        </div>

        <!-- ADD NEW CUSTOMER -->
        <div class="customer-form">
          <div class="section-title">‚ûï Add New Customer</div>
          <div class="form-grid grid-2">
            <div class="form-group">
			<label for="addCustomerName">Customer Name (Min 3 Chars) <span class="required">*</span></label>
              <input type="text" id="newCustomerName" placeholder="Customer Name*" />
            </div>
            <div class="form-group">
			<label for="addCustomerPhone">Phone (10 Digits) <span class="required">*</span></label>
              <input type="text" id="newCustomerPhone" placeholder="Customer Phone*" />
            </div>
            <div class="form-group">
			<label for="addCustomerAddress">Customer Address (Min 5 Chars)<span class="required">*</span></label>
              <input type="text" id="newCustomerAddress" placeholder="Customer Address" />
            </div>
            <!-- <div class="form-group">
			<label for="addCustomerEmail">Customer Email</label>
              <input type="email" id="newCustomerEmail" placeholder="Customer Email" />
            </div> -->
          </div>
          <div class="btn-group">
            <button class="btn btn-warning" onclick="addNewCustomerToMaster()">Add to Customer Master</button>
			<!-- <button type="button" onclick="addNewCustomerToMaster()">Add to Customer Master</button> -->
          </div>
        </div>

        <form id="invoiceForm" autocomplete="off">
          <!-- COMPANY DETAILS -->
          <div class="section-title">üè¢ Company / Sender Details</div>
          <div class="form-grid grid-2">
            <div>
              <div class="form-group">
                <label>Company Name</label>
                <input required id="companyName" value="G3 Beauty Lounge" />
              </div>
              <div class="form-group">
                <label>Address</label>
                <textarea required id="companyAddress">5/432, 2nd Cross, Sairam Nagar,
Near Best Writing Institute,
Medavakkam, Chennai 600100</textarea>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input required id="companyPhone" value="PH:7904081684"/>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input required id="companyEmail" value="Email: g3beautylounge@gmail.com"/>
              </div>
            </div>
            <div>
              <div class="form-group">
                <label>Logo Upload (Optional, ‚â§200KB)</label>
                <input type="file" accept="image/*" id="logoUpload" />
                <img id="logoPreview" style="display:none; max-width: 150px; margin-top: 10px; border-radius: 8px;" alt="Logo Preview"/>
              </div>
            </div>
          </div>

          <!-- CLIENT DETAILS WITH ENHANCED SEARCH & LOV -->
          <div class="section-title">üë§ Client / Recipient Details</div>
          
          <!-- Enhanced Customer Search Box with Clear and Show All Buttons -->
          <div class="search-box" id="customerSearchBox">
            <label>üîç Search Customers</label>
            <div class="search-container">
              <input type="text" class="search-input" id="customerSearchInput" placeholder="Type to search customers by name or phone..." />
              <button class="clear-search-btn" id="clearSearchBtn" onclick="clearCustomerSearch()">üóëÔ∏è Clear</button>
              <button class="show-all-btn" id="showAllBtn" onclick="showAllCustomers()">üë• Show All</button>
            </div>
            <div class="lov-dropdown" id="lovDropdown" style="display:none;">
              <div class="no-results">Start typing to search customers...</div>
            </div>
          </div>
          
          <div class="form-grid grid-2">
            <div class="form-group">
              <label>Client Name</label>
              <div class="client-name-container">
                <input required id="clientName" onclick="toggleClientNameDropdown()" readonly placeholder="Click to select customer"/>
                <div class="client-name-dropdown" id="clientNameDropdown"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input id="clientPhone"/>
            </div>
            <div class="form-group">
              <label>Address</label>
              <input required id="clientAddress"/>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input id="clientEmail"/>
            </div>
          </div>

          <!-- INVOICE INFORMATION -->
          <div class="section-title">üìã Invoice Information</div>
          <div class="form-grid grid-3">
            <div class="form-group">
              <label>Invoice Number</label>
              <input required id="invoiceNumber" />
            </div>
            <div class="form-group">
              <label>Date</label>
              <input type="date" required id="invoiceDate" />
            </div>
            <div class="form-group">
              <label>Currency</label>
              <select id="currency">
                <option value="INR">INR ‚Çπ</option>
                <option value="USD">USD $</option>
              </select>
            </div>
          </div>

          <!-- INVOICE ITEMS -->
          <div class="section-title">üìù Invoice Items</div>
          <div class="table-container">
            <table class="invoice-items" id="itemsTable">
              <thead>
                <tr>
                  <th class="desc-cell">Item Description</th>
                  <th class="qty-cell">Qty</th>
                  <th class="unit-cell">Unit Price</th>
                  <th class="total-cell">Total</th>
                  <th class="action-cell">Action</th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>
          
          <div class="btn-group">
            <button type="button" class="btn btn-success btn-sm" onclick="addItemRow()">‚ûï Add Item</button>
            <button type="button" class="btn btn-warning btn-sm" onclick="addAdhocItemRow()">‚úèÔ∏è Add Custom Item</button>
          </div>

          <!-- SUMMARY & NOTES -->
          <div class="section-title">üí∞ Summary & Notes</div>
          <div class="summary-grid">
            <div class="summary-card">
              <div class="form-group">
                <label>Notes</label>
                <textarea id="notes">UPI and CASH accepted. Thank you for your business! Get Extra 5% for referrals</textarea>
              </div>
              <div class="form-group">
                <label>Terms & Conditions</label>
                <textarea id="terms">All services are non-refundable.</textarea>
              </div>
            </div>
            
            <div class="summary-card">
              <div style="margin-bottom: 10px;"><strong>Subtotal:</strong> <span id="subtotalDisplay">‚Çπ0.00</span></div>
              
              <div class="form-group">
                <label>Tax Rate (%)</label>
                <input type="number" min="0" step="1" id="taxRate" value="0"/>
              </div>
              <div style="margin-bottom: 10px;">Tax: <span id="taxAmountDisplay">‚Çπ0.00</span></div>
              
              <div class="form-group">
                <label>Discount (%)</label>
                <input type="number" min="0" max="99" step="1" id="discountRate" value="10"/>
              </div>
              <div style="margin-bottom: 10px;">Discount: <span id="discountAmountDisplay">‚Çπ0.00</span></div>
              
              <div class="total-display">
                <strong>Total: <span id="totalDisplay">‚Çπ0.00</span></strong>
              </div>
            </div>
          </div>

          <!-- ACTION BUTTONS -->
          <div class="section-title">‚ö° Actions</div>
          
          <!-- Preview & Export -->
          <div class="btn-group">
            <button type="button" class="btn btn-info" onclick="previewInvoice()">üëÅÔ∏è Preview</button>
            <button type="button" class="btn btn-primary" onclick="generatePDF()">üìÑ Generate PDF</button>
            <!-- <button type="button" class="btn btn-warning" onclick="exportToJPEG()">üñºÔ∏è Export JPEG</button> -->
          </div>

          <!-- Customer Management -->
          <div class="btn-group">
            <!-- <button type="button" class="btn btn-success" onclick="addCurrentClientToMaster()">üë§ Add Client to Master</button> -->
            <button type="button" class="btn btn-info" onclick="downloadAllCustomersCSV()">üì• Download Customer CSV</button>
          <!-- </div>

          <!-- Invoice Management -->
          <!-- <div class="btn-group"> -->
            <button type="button" class="btn btn-secondary" onclick="saveInvoiceToMaster()">üíæ Save to Invoice Master</button>
            <!-- <button type="button" class="btn btn-warning" onclick="saveDraft()">üìù Save Draft</button> -->
            <button type="button" class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear Form</button>
          </div>
        </form>

        <!-- CUSTOMER STATUS -->
        <div class="status-card" id="customerMasterCount">Customer Master: 0 customers</div>
      </div>
    </div>
	
	 <!-- PREVIEW SECTION -->
    <div class="preview-section">
      <div class="preview-header">üìã Invoice Preview</div>
      <div id="previewBox" class="fade-in">
        <div class="invoice-preview" id="invoicePreview">
          <div style="text-align: center; color: #999; padding: 40px;">
            Click "Preview" to see your invoice here
          </div>
        </div>
      </div>

      <!-- COMPACT INVOICE HISTORY -->
      <div class="section-title" style="margin-top: 30px;">üìö Invoice History</div>
      <ul class="history-list" id="invoiceHistory"></ul>

      <!-- COMPACT INVOICE MASTER - SINGLE ROW LAYOUT -->
      <div class="section-title" style="margin-top: 30px;">üóÉÔ∏è Invoice Master</div>
      <ul class="history-list" id="invoiceMasterList"></ul>
    </div> 
    
  </div>

<script>
// GLOBAL VARIABLES
let masterItems = [];
let allCustomers = []; 
let logoDataURL = "";
let currency = 'INR';
let searchTimeout;
let selectedCustomerIndex = -1;
let clientNameDropdownVisible = false;

// UTILITY FUNCTION
const $ = id => {
  try {
    return document.getElementById(id);
  } catch (e) {
    console.error(`Element not found: ${id}`, e);
    return null;
  }
};

// CLEAR ALL CUSTOMER DATA ON EVERY APP LOAD
function clearCustomerDataOnLoad() {
  try {
    localStorage.removeItem('customer_master_list');
    localStorage.removeItem('customerMasterData');
    localStorage.removeItem('customerCSVData');
    allCustomers = [];
    console.log('‚úÖ Customer data cleared on app load');
  } catch (e) {
    console.error('Error clearing customer data:', e);
  }
}

// UPDATE CUSTOMER MASTER COUNT DISPLAY
function updateCustomerMasterCount() {
  try {
    const count = allCustomers.length;
    const element = $("customerMasterCount");
    if (element) {
      element.textContent = `Customer Master: ${count} customers`;
    }
  } catch (e) {
    console.error('Error updating customer master count:', e);
  }
}

// CLEAR CUSTOMER SEARCH FUNCTION
function clearCustomerSearch() {
  try {
    const searchInput = $("customerSearchInput");
    const lovDropdown = $("lovDropdown");
    
    if (searchInput) searchInput.value = "";
    if (lovDropdown) lovDropdown.style.display = "none";
    
    selectedCustomerIndex = -1;
    console.log('‚úÖ Search cleared');
  } catch (e) {
    console.error('Error clearing search:', e);
  }
}

// SHOW ALL CUSTOMERS FUNCTION
function showAllCustomers() {
  try {
    const lovDropdown = $("lovDropdown");
    if (!lovDropdown) return;

    // Clear previous results
    lovDropdown.innerHTML = '';
    selectedCustomerIndex = -1;

    if (allCustomers.length === 0) {
      lovDropdown.innerHTML = '<div class="no-results">No customers available. Add customers or load from CSV.</div>';
    } else {
      allCustomers.forEach((customer, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'lov-item';
        
        // Display name and phone in LOV
        const name = customer.Name || customer.name || 'Unknown';
        const phone = customer.Phone || customer.phone || '';
        resultItem.innerHTML = `<strong>${name}</strong> ${phone ? '- ' + phone : ''}`;
        
        resultItem.addEventListener('click', () => {
          selectCustomerFromLOV(customer);
          lovDropdown.style.display = 'none';
          selectedCustomerIndex = -1;
        });

        lovDropdown.appendChild(resultItem);
      });
    }

    lovDropdown.style.display = 'block';
    console.log(`‚úÖ Showing all ${allCustomers.length} customers`);
  } catch (e) {
    console.error('Error showing all customers:', e);
  }
}

// DELTA CODE: Add New Customer Validation
        function validateAddCustomer(event) {
            event.preventDefault();
            
            const nameField = document.getElementById('addCustomerName');
            const phoneField = document.getElementById('addCustomerPhone');
            
            const name = nameField.value.trim();
            const phone = phoneField.value.trim();
            
            // Validate customer name
            if (!name) {
                alert('Customer Name is required');
                nameField.focus();
                return false;
            }
            
            if (name.length < 2) {
                alert('Customer Name must be at least 2 characters long');
                nameField.focus();
                return false;
            }
            
            // Validate phone
            if (!phone) {
                alert('Customer Phone is required');
                phoneField.focus();
                return false;
            }
            
            // Check if phone contains only digits
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length < 10 || phoneDigits.length > 15) {
                alert('Please enter a valid phone number (10-15 digits)');
                phoneField.focus();
                return false;
            }
            
            if (!/^[0-9]+$/.test(phone)) {
                alert('Phone number should contain only digits');
                phoneField.focus();
                return false;
            }
            
            // If validation passes
            alert('Customer added successfully!');
            nameField.value = '';
            phoneField.value = '';
            return true;
        }

        // DELTA CODE: Clear Client Selection and Search History
        function clearClientSelection() {
            // Clear all client detail fields
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientEmail').value = '';
            
            // Clear search field
            document.getElementById('searchCustomers').value = '';
            
            // Clear any stored search history if it exists
            if (window.customerSearchHistory) {
                window.customerSearchHistory = [];
            }
            
            // Clear any cached search results
            if (window.searchResults) {
                window.searchResults = [];
            }
            
            console.log('Client selection and search history cleared');
        }

// CLIENT NAME DROPDOWN TOGGLE FUNCTION
function toggleClientNameDropdown() {
  try {
    const dropdown = $("clientNameDropdown");
    if (!dropdown) return;

    if (clientNameDropdownVisible) {
      dropdown.style.display = 'none';
      clientNameDropdownVisible = false;
    } else {
      populateClientNameDropdown();
      dropdown.style.display = 'block';
      clientNameDropdownVisible = true;
    }
  } catch (e) {
    console.error('Error toggling client name dropdown:', e);
  }
}

// POPULATE CLIENT NAME DROPDOWN WITH ALL CUSTOMERS
function populateClientNameDropdown() {
  try {
    const dropdown = $("clientNameDropdown");
    if (!dropdown) return;

    dropdown.innerHTML = '';

    if (allCustomers.length === 0) {
      dropdown.innerHTML = '<div class="client-name-item">No customers available</div>';
      return;
    }

    allCustomers.forEach((customer, index) => {
      const item = document.createElement('div');
      item.className = 'client-name-item';
      
      const name = customer.Name || customer.name || 'Unknown';
      const phone = customer.Phone || customer.phone || '';
      item.innerHTML = `<strong>${name}</strong> ${phone ? '- ' + phone : ''}`;
      
      item.addEventListener('click', () => {
        selectCustomerFromClientDropdown(customer);
        dropdown.style.display = 'none';
        clientNameDropdownVisible = false;
      });

      dropdown.appendChild(item);
    });
  } catch (e) {
    console.error('Error populating client name dropdown:', e);
  }
}

// SELECT CUSTOMER FROM CLIENT NAME DROPDOWN
function selectCustomerFromClientDropdown(customer) {
  try {
    const clientName = $("clientName");
    const clientAddress = $("clientAddress");
    const clientPhone = $("clientPhone");
    const clientEmail = $("clientEmail");
    
    if (clientName) clientName.value = customer.Name || customer.name || "";
    if (clientAddress) clientAddress.value = customer.Address || customer.address || "";
    if (clientPhone) clientPhone.value = customer.Phone || customer.phone || "";
    if (clientEmail) clientEmail.value = customer.Email || customer.email || "";
    
    console.log(`‚úÖ Customer "${customer.Name || customer.name}" selected from client dropdown`);
  } catch (e) {
    console.error('Error selecting customer from client dropdown:', e);
  }
}

// ENHANCED CUSTOMER SEARCH WITH LOV
function setupCustomerSearch() {
  const searchInput = $("customerSearchInput");
  const lovDropdown = $("lovDropdown");
  
  if (!searchInput || !lovDropdown) return;

  // Real-time search with debounce
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim().toLowerCase();
    
    if (query === '') {
      lovDropdown.style.display = 'none';
      return;
    }

    searchTimeout = setTimeout(() => {
      searchCustomersLOV(query);
    }, 300);
  });

  // Handle keyboard navigation
  searchInput.addEventListener('keydown', function(e) {
    const items = lovDropdown.querySelectorAll('.lov-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedCustomerIndex = Math.min(selectedCustomerIndex + 1, items.length - 1);
      updateSelectedCustomerLOV(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedCustomerIndex = Math.max(selectedCustomerIndex - 1, -1);
      updateSelectedCustomerLOV(items);
    } else if (e.key === 'Enter' && selectedCustomerIndex >= 0) {
      e.preventDefault();
      items[selectedCustomerIndex].click();
    } else if (e.key === 'Escape') {
      lovDropdown.style.display = 'none';
      selectedCustomerIndex = -1;
    }
  });

  // Hide LOV dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !lovDropdown.contains(e.target)) {
      lovDropdown.style.display = 'none';
      selectedCustomerIndex = -1;
    }
    
    // Hide client name dropdown when clicking outside
    const clientName = $("clientName");
    const clientDropdown = $("clientNameDropdown");
    if (clientName && clientDropdown && !clientName.contains(e.target) && !clientDropdown.contains(e.target)) {
      clientDropdown.style.display = 'none';
      clientNameDropdownVisible = false;
    }
  });
}

function searchCustomersLOV(query) {
  const lovDropdown = $("lovDropdown");
  if (!lovDropdown) return;

  // Filter customers by name and phone only
  const filteredCustomers = allCustomers.filter(customer => {
    const name = (customer.Name || customer.name || '').toLowerCase();
    const phone = (customer.Phone || customer.phone || '').toLowerCase();
    
    return name.includes(query) || phone.includes(query);
  });

  // Clear previous results
  lovDropdown.innerHTML = '';
  selectedCustomerIndex = -1;

  if (filteredCustomers.length === 0) {
    lovDropdown.innerHTML = '<div class="no-results">No customers found</div>';
  } else {
    filteredCustomers.forEach((customer, index) => {
      const resultItem = document.createElement('div');
      resultItem.className = 'lov-item';
      
      // Display only name and phone in LOV
      const name = customer.Name || customer.name || 'Unknown';
      const phone = customer.Phone || customer.phone || '';
      resultItem.innerHTML = `<strong>${name}</strong> ${phone ? '- ' + phone : ''}`;
      
      resultItem.addEventListener('click', () => {
        selectCustomerFromLOV(customer);
        lovDropdown.style.display = 'none';
        selectedCustomerIndex = -1;
      });

      lovDropdown.appendChild(resultItem);
    });
  }

  lovDropdown.style.display = 'block';
}

function updateSelectedCustomerLOV(items) {
  items.forEach((item, index) => {
    item.classList.toggle('selected', index === selectedCustomerIndex);
  });
}

function selectCustomerFromLOV(customer) {
  try {
    const clientName = $("clientName");
    const clientAddress = $("clientAddress");
    const clientPhone = $("clientPhone");
    const clientEmail = $("clientEmail");
    const searchInput = $("customerSearchInput");
    
    if (clientName) clientName.value = customer.Name || customer.name || "";
    if (clientAddress) clientAddress.value = customer.Address || customer.address || "";
    if (clientPhone) clientPhone.value = customer.Phone || customer.phone || "";
    if (clientEmail) clientEmail.value = customer.Email || customer.email || "";
    
    // Clear search input after selection
    if (searchInput) searchInput.value = "";
    
    console.log(`‚úÖ Customer "${customer.Name || customer.name}" selected from LOV`);
  } catch (e) {
    console.error('Error selecting customer from LOV:', e);
  }
}

// ADD NEW CUSTOMER TO MASTER
function addNewCustomerToMaster() {
  try {
    const name = $("newCustomerName")?.value?.trim() || '';
    const address = $("newCustomerAddress")?.value?.trim() || '';
    const phone = $("newCustomerPhone")?.value?.trim() || '';
    const email = $("newCustomerEmail")?.value?.trim() || '';
    
    if (!name) {
      alert("‚ùå Customer name is required!");
      return;
    }
	
	// Validation
    if (!name || name.length < 2) {
        alert('Customer name is required and should be at least 2 characters.');
        nameInput.focus();
        return;
    }

    const phoneDigits = phone.replace(/\D/g, '');
    if (!phone || phoneDigits.length < 10 || phoneDigits.length > 15) {
        alert('Phone number is required and should be 10-15 digits only.');
        phoneInput.focus();
        return;
    }
	
	if (!address || address.length < 5) {
        alert('Address is required and should be at least 5 characters.');
        addressInput.focus();
        return;
    }
	
    // Check for duplicates
    const duplicate = allCustomers.find(existing => {
      <!-- const nameMatch = (existing.Name || existing.name || '').toLowerCase() === name.toLowerCase(); -->
      const phoneMatch = phone && (existing.Phone || existing.phone) && 
                        (existing.Phone || existing.phone).replace(/\D/g, '') === phone.replace(/\D/g, '');
      const emailMatch = email && (existing.Email || existing.email) && 
                        (existing.Email || existing.email).toLowerCase() === email.toLowerCase();
      
      <!-- return nameMatch || phoneMatch || emailMatch; -->
	  return phoneMatch || emailMatch;  
	 
    });
    
    if (duplicate) {
      const dupName = duplicate.Name || duplicate.name || 'Unknown';
      const dupPhone = duplicate.Phone || duplicate.phone || '';
      const dupEmail = duplicate.Email || duplicate.email || '';
      alert(`‚ùå Customer already exists!\n\nExisting: ${dupName}\nPhone: ${dupPhone}\nEmail: ${dupEmail}\n\nDuplicate not added.`);
      return;
    }
    
    // Add new customer
    const newCustomer = {
      Name: name,
      name: name,
      Address: address,
      address: address,
      Phone: phone,
      phone: phone,
      Email: email,
      email: email,
      dateAdded: new Date().toISOString().split('T')[0]
    };
    
    allCustomers.push(newCustomer);
    
    // Clear form fields
    const fields = ["newCustomerName", "newCustomerAddress", "newCustomerPhone", "newCustomerEmail"];
    fields.forEach(fieldId => {
      const field = $(fieldId);
      if (field) field.value = "";
    });
    
    updateCustomerMasterCount();
    alert(`‚úÖ Customer "${name}" added successfully!\nTotal customers: ${allCustomers.length}`);
    
  } catch (e) {
    console.error('Error in addNewCustomerToMaster:', e);
    alert('‚ùå Error adding new customer!');
  }
}

// ADD CURRENT CLIENT TO MASTER
function addCurrentClientToMaster() {
  try {
    const name = $("clientName")?.value?.trim() || '';
    const address = $("clientAddress")?.value?.trim() || '';
    const phone = $("clientPhone")?.value?.trim() || '';
    const email = $("clientEmail")?.value?.trim() || '';
    
    if (!name) {
      alert("‚ùå Please enter client name first!");
      return;
    }
    
    const duplicate = allCustomers.find(existing => {
      const nameMatch = (existing.Name || existing.name || '').toLowerCase() === name.toLowerCase();
      const phoneMatch = phone && (existing.Phone || existing.phone) && 
                        (existing.Phone || existing.phone).replace(/\D/g, '') === phone.replace(/\D/g, '');
      const emailMatch = email && (existing.Email || existing.email) && 
                        (existing.Email || existing.email).toLowerCase() === email.toLowerCase();
      
      return nameMatch || phoneMatch || emailMatch;
    });
    
    if (duplicate) {
      alert(`‚ùå Client already exists in customer master!`);
      return;
    }
    
    const newCustomer = {
      Name: name,
      name: name,
      Address: address,
      address: address,
      Phone: phone,
      phone: phone,
      Email: email,
      email: email,
      dateAdded: new Date().toISOString().split('T')[0]
    };
    
    allCustomers.push(newCustomer);
    updateCustomerMasterCount();
    
    alert(`‚úÖ Client "${name}" added to customer master!\nTotal customers: ${allCustomers.length}`);
    
  } catch (e) {
    console.error('Error in addCurrentClientToMaster:', e);
    alert('‚ùå Error adding client to master!');
  }
}

// FIXED CSV HANDLING FUNCTIONS
function csvToArray(text) {
  try {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) {
      console.warn('CSV file has no data rows');
      return [];
    }
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
      if (lines[i].trim() === '') continue; // Skip empty lines
      
      const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
      const obj = {};
      
      headers.forEach((header, index) => {
        obj[header] = values[index] || '';
      });
      
      data.push(obj);
    }
    
    return data;
  } catch (e) {
    console.error('Error parsing CSV:', e);
    return [];
  }
}

// FIXED LOAD ITEMS MASTER FUNCTION
function loadItemsMaster() {
  try {
    const input = $("itemCsvInput");
    if (!input || !input.files || !input.files[0]) {
      alert("‚ùå Please choose an items CSV file first.");
      return;
    }
    
    console.log('Loading items CSV...');
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const text = e.target.result;
        console.log('CSV text loaded:', text.substring(0, 200) + '...');
        
        masterItems = csvToArray(text);
        
        const statusEl = $("masterStatus");
        if (statusEl) {
          statusEl.textContent = `‚úÖ ${masterItems.length} items loaded`;
          statusEl.style.color = 'green';
        }
        
        console.log('Items loaded successfully:', masterItems);
        /* alert(`‚úÖ Successfully loaded ${masterItems.length} items from CSV!`); */
        
        // Refresh the existing item rows to include new master items
        refreshItemRows();
        
      } catch (err) {
        console.error('Error processing items CSV:', err);
        const statusEl = $("masterStatus");
        if (statusEl) {
          statusEl.textContent = `‚ùå Error loading items: ${err.message}`;
          statusEl.style.color = 'red';
        }
        alert('‚ùå Error loading items CSV: ' + err.message);
      }
    };
    
    reader.onerror = function(err) {
      console.error('FileReader error:', err);
      alert('‚ùå Error reading CSV file!');
    };
    
    reader.readAsText(input.files[0]);
    
  } catch (e) {
    console.error('Error in loadItemsMaster:', e);
    alert('‚ùå Error loading CSV file: ' + e.message);
  }
}

// FIXED LOAD CUSTOMERS MASTER FUNCTION
function loadCustomersMaster() {
  try {
    const input = $("customerCsvInput");
    if (!input || !input.files || !input.files[0]) {
      alert("‚ùå Please choose a customers CSV file first.");
      return;
    }
    
    console.log('Loading customers CSV...');
    const reader = new FileReader();
    
    reader.onload = function(e) {
      try {
        const text = e.target.result;
        console.log('Customer CSV text loaded:', text.substring(0, 200) + '...');
        
        const csvCustomers = csvToArray(text);
        console.log('Parsed CSV customers:', csvCustomers);
        
        let addedCount = 0;
        let skippedCount = 0;
        
        csvCustomers.forEach(csvCustomer => {
          // Try different possible column names for flexibility
          const name = csvCustomer.Name || csvCustomer['Customer Name'] || csvCustomer.name || csvCustomer.customer_name || '';
          const phone = csvCustomer.Phone || csvCustomer['Customer Phone'] || csvCustomer.phone || csvCustomer.customer_phone || '';
          const email = csvCustomer.Email || csvCustomer['Customer Email'] || csvCustomer.email || csvCustomer.customer_email || '';
          const address = csvCustomer.Address || csvCustomer['Customer Address'] || csvCustomer.address || csvCustomer.customer_address || '';
          
          if (name.trim()) {
            // Check for duplicates
            const duplicate = allCustomers.find(existing => {
              const nameMatch = (existing.Name || existing.name || '').toLowerCase() === name.toLowerCase();
              const phoneMatch = phone && (existing.Phone || existing.phone) && 
                                (existing.Phone || existing.phone).replace(/\D/g, '') === phone.replace(/\D/g, '');
              const emailMatch = email && (existing.Email || existing.email) && 
                                (existing.Email || existing.email).toLowerCase() === email.toLowerCase();
              
              return nameMatch || phoneMatch || emailMatch;
            });
            
            if (!duplicate) {
              const normalizedCustomer = {
                Name: name,
                name: name,
                Address: address,
                address: address,
                Phone: phone,
                phone: phone,
                Email: email,
                email: email,
                dateAdded: new Date().toISOString().split('T')[0]
              };
              
              allCustomers.push(normalizedCustomer);
              addedCount++;
            } else {
              skippedCount++;
            }
          }
        });
        
        const statusEl = $("customerMasterStatus");
        if (statusEl) {
          statusEl.textContent = `‚úÖ ${addedCount} new customers loaded`;
          statusEl.style.color = 'green';
        }
        
        updateCustomerMasterCount();
        
        console.log(`Customers loaded: ${addedCount}, skipped: ${skippedCount}`);
        /* alert(`‚úÖ CSV loaded successfully!\n\nNew customers added: ${addedCount}\nDuplicates skipped: ${skippedCount}\nTotal customers: ${allCustomers.length}`); */
        
      } catch (error) {
        console.error("Error processing customers CSV:", error);
        const statusEl = $("customerMasterStatus");
        if (statusEl) {
          statusEl.textContent = `‚ùå Error loading customers: ${error.message}`;
          statusEl.style.color = 'red';
        }
        alert("‚ùå Error reading customer CSV file: " + error.message);
      }
    };
    
    reader.onerror = function(err) {
      console.error('FileReader error:', err);
      alert('‚ùå Error reading CSV file!');
    };
    
    reader.readAsText(input.files[0]);
    
  } catch (e) {
    console.error('Error in loadCustomersMaster:', e);
    alert('‚ùå Error loading customer CSV: ' + e.message);
  }
}

// REFRESH ITEM ROWS TO USE LOADED MASTER ITEMS
function refreshItemRows() {
  try {
    const tbody = $("itemsBody");
    if (!tbody) return;
    
    // Update existing rows that have selects
    [...tbody.rows].forEach(row => {
      const descCell = row.cells[0];
      const currentInput = descCell.querySelector('input');
      const currentSelect = descCell.querySelector('select');
      
      if (currentInput && !currentSelect && masterItems.length > 0) {
        // Replace input with select for master items
        const currentValue = currentInput.value;
        descCell.innerHTML = '';
        
        const select = document.createElement("select");
        select.innerHTML = '<option value="">Select item...</option>' + 
          masterItems.map(mi => {
            const desc = mi["Description"] || mi.description || mi.item || '';
            return `<option value="${desc}">${desc}</option>`;
          }).join("");
        
        // Try to match current value
        if (currentValue) {
          const matchingOption = [...select.options].find(opt => opt.value === currentValue);
          if (matchingOption) {
            select.value = currentValue;
          }
        }
        
        select.onchange = function() {
          const selItem = masterItems.find(mi => 
            (mi["Description"] || mi.description || mi.item) === this.value
          );
          if (selItem && row.cells[2] && row.cells[2].firstElementChild) {
            row.cells[2].firstElementChild.value = selItem["Unit Price"] || selItem.unit_price || selItem.price || "";
            updateTotals();
          }
        };
        
        descCell.appendChild(select);
      }
    });
    
  } catch (e) {
    console.error('Error refreshing item rows:', e);
  }
}

// DOWNLOAD ALL CUSTOMERS CSV
function downloadAllCustomersCSV() {
  try {
    if (allCustomers.length === 0) {
      alert("‚ùå No customers to download! Add customers first.");
      return;
    }
    
    const headers = ['Name', 'Address', 'Phone', 'Email', 'Date Added'];
    let csvContent = headers.join(',') + '\r\n';
    
    allCustomers.forEach(customer => {
      const row = [
        customer.Name || customer.name || '',
        customer.Address || customer.address || '',
        customer.Phone || customer.phone || '',
        customer.Email || customer.email || '',
        customer.dateAdded || ''
      ].map(value => {
        if (value && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
          return '"' + value.replace(/"/g, '""') + '"';
        }
        return value;
      });
      csvContent += row.join(',') + '\r\n';
    });
    
    const now = new Date();
    const timestamp = now.getFullYear() + 
                     String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0') + '_' +
                     String(now.getHours()).padStart(2, '0') + 
                     String(now.getMinutes()).padStart(2, '0');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Customer_Master_${timestamp}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Downloaded customer master CSV!\n\nFilename: Customer_Master_${timestamp}.csv\nTotal customers: ${allCustomers.length}`);
    
  } catch (e) {
    console.error('Error downloading customers CSV:', e);
    alert('‚ùå Error downloading customer CSV!');
  }
}

// UTILITY FUNCTIONS
function formatCurrency(val, cur, noDecimals) {
  try {
    let num = parseFloat(val) || 0;
    if (noDecimals) {
      num = Math.round(num);
      return cur === "INR" ? "‚Çπ" + num.toLocaleString("en-IN") : "$" + num.toLocaleString("en-US");
    }
    return cur === "INR" ? "‚Çπ" + num.toLocaleString("en-IN", {minimumFractionDigits: 2}) : "$" + num.toLocaleString("en-US", {minimumFractionDigits: 2});
  } catch (e) {
    console.error('Error formatting currency:', e);
    return cur === "INR" ? "‚Çπ0.00" : "$0.00";
  }
}

function nextInvoiceNumber() {
  try {
    let seq = +localStorage.getItem('invoice_seq') || 1;
    localStorage.setItem('invoice_seq', seq + 1);
    return "INV-" + (String(seq).padStart(4, '0'));
  } catch (e) {
    console.error('Error generating invoice number:', e);
    return "INV-0001";
  }
}

// INVOICE ITEMS FUNCTIONS
function addItemRow(item = {desc: "", qty: 1, unit: 0}) {
  try {
    let tbody = $("itemsBody");
    if (!tbody) return;
    
    let tr = document.createElement("tr");
    let descCell = document.createElement("td");
    descCell.className = "desc-cell";
    
    if (masterItems.length > 0) {
      let select = document.createElement("select");
      select.innerHTML = '<option value="">Select item...</option>' + 
        masterItems.map(mi => {
          const desc = mi["Description"] || mi.description || mi.item || '';
          return `<option value="${desc}">${desc}</option>`;
        }).join("");
      
      select.value = item.desc || "";
      select.onchange = function() {
        let selItem = masterItems.find(mi => 
          (mi["Description"] || mi.description || mi.item) === this.value
        );
        if (selItem && tr.cells[2] && tr.cells[2].firstElementChild) {
          tr.cells[2].firstElementChild.value = selItem["Unit Price"] || selItem.unit_price || selItem.price || "";
          updateTotals();
        }
      };
      descCell.appendChild(select);
    } else {
      let input = document.createElement("input");
      input.value = item.desc || "";
      input.onchange = updateTotals;
      descCell.appendChild(input);
    }

    let qtyCell = document.createElement("td");
    qtyCell.className = "qty-cell";
    let qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.min = "1";
    qtyInput.value = item.qty || "1";
    qtyInput.className = "qty-input";
    qtyInput.onchange = updateTotals;
    qtyCell.appendChild(qtyInput);

    let unitCell = document.createElement("td");
    unitCell.className = "unit-cell";
    let unitInput = document.createElement("input");
    unitInput.type = "number";
    unitInput.min = "0";
    unitInput.step = "1";
    unitInput.value = item.unit || "0";
    unitInput.className = "unit-input";
    unitInput.onchange = updateTotals;
    unitCell.appendChild(unitInput);

    let totalCell = document.createElement("td");
    totalCell.className = "total-cell";

    let actionCell = document.createElement("td");
    actionCell.className = "action-cell";
    let removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn btn-danger btn-sm";
    removeBtn.innerHTML = "‚ùå";
    removeBtn.onclick = function() {
      tr.remove();
      updateTotals();
    };
    actionCell.appendChild(removeBtn);

    tr.appendChild(descCell);
    tr.appendChild(qtyCell);
    tr.appendChild(unitCell);
    tr.appendChild(totalCell);
    tr.appendChild(actionCell);
    tbody.appendChild(tr);
    updateTotals();
  } catch (e) {
    console.error('Error adding item row:', e);
  }
}

function addAdhocItemRow() {
  try {
    let tbody = $("itemsBody");
    if (!tbody) return;
    
    let tr = document.createElement("tr");
    let descCell = document.createElement("td");
    descCell.className = "desc-cell";
    let input = document.createElement("input");
    input.placeholder = "Enter custom item...";
    input.onchange = updateTotals;
    descCell.appendChild(input);

    let qtyCell = document.createElement("td");
    qtyCell.className = "qty-cell";
    let qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.min = "1";
    qtyInput.value = "1";
    qtyInput.className = "qty-input";
    qtyInput.onchange = updateTotals;
    qtyCell.appendChild(qtyInput);

    let unitCell = document.createElement("td");
    unitCell.className = "unit-cell";
    let unitInput = document.createElement("input");
    unitInput.type = "number";
    unitInput.min = "0";
    unitInput.step = "1";
    unitInput.value = "0";
    unitInput.className = "unit-input";
    unitInput.onchange = updateTotals;
    unitCell.appendChild(unitInput);

    let totalCell = document.createElement("td");
    totalCell.className = "total-cell";

    let actionCell = document.createElement("td");
    actionCell.className = "action-cell";
    let removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn btn-danger btn-sm";
    removeBtn.innerHTML = "‚ùå";
    removeBtn.onclick = function() {
      tr.remove();
      updateTotals();
    };
    actionCell.appendChild(removeBtn);

    tr.appendChild(descCell);
    tr.appendChild(qtyCell);
    tr.appendChild(unitCell);
    tr.appendChild(totalCell);
    tr.appendChild(actionCell);
    tbody.appendChild(tr);
    updateTotals();
  } catch (e) {
    console.error('Error adding adhoc item row:', e);
  }
}

function updateTotals() {
  try {
    let tbody = $("itemsBody");
    if (!tbody) return;
    
    let subtotal = 0;
    [...tbody.rows].forEach(row => {
      let desc = row.cells[0].querySelector("input, select")?.value || '';
      let qty = row.cells[1].firstElementChild?.valueAsNumber || 0;
      let unit = row.cells[2].firstElementChild?.valueAsNumber || 0;
      let total = qty * unit;
      if (row.cells[3]) {
        row.cells[3].textContent = formatCurrency(total, currency);
      }
      subtotal += total;
    });

    const subtotalDisplay = $("subtotalDisplay");
    if (subtotalDisplay) {
      subtotalDisplay.textContent = formatCurrency(subtotal, currency);
    }
    
    let taxRate = +($("taxRate")?.value) || 0;
    let discountRate = +($("discountRate")?.value) || 0;
    let taxAmount = subtotal * taxRate / 100;
    let discountAmount = (subtotal + taxAmount) * discountRate / 100;
    let _total = subtotal + taxAmount - discountAmount;

    const taxAmountDisplay = $("taxAmountDisplay");
    const discountAmountDisplay = $("discountAmountDisplay");
    const totalDisplay = $("totalDisplay");

    if (taxAmountDisplay) taxAmountDisplay.textContent = formatCurrency(taxAmount, currency);
    if (discountAmountDisplay) discountAmountDisplay.textContent = formatCurrency(discountAmount, currency);
    if (totalDisplay) totalDisplay.textContent = formatCurrency(Math.round(_total), currency, true);
  } catch (e) {
    console.error('Error updating totals:', e);
  }
}

// INITIALIZE APPLICATION
function setInvoiceDefaults() {
  try {
    const invoiceNumber = $("invoiceNumber");
    const invoiceDate = $("invoiceDate");
    
    if (invoiceNumber) invoiceNumber.value = nextInvoiceNumber();
    if (invoiceDate) invoiceDate.valueAsDate = new Date();
  } catch (e) {
    console.error('Error setting invoice defaults:', e);
  }
}

function initializeItemsTable() {
  try {
    const tbody = $("itemsBody");
    if (tbody && tbody.rows.length === 0) {
      addItemRow();
    }
  } catch (e) {
    console.error('Error initializing items table:', e);
  }
}

// FORM SERIALIZATION
function serializeForm() {
  try {
    let tbody = $("itemsBody");
    let items = [];
    
    if (tbody) {
      items = [...tbody.rows].map(row => ({
        desc: row.cells[0].querySelector("input,select")?.value || '',
        qty: row.cells[1].firstElementChild?.value || '0',
        unit: row.cells[2].firstElementChild?.value || '0'
      }));
    }
    
    const getFieldValue = (id) => {
      const field = $(id);
      return field ? field.value : '';
    };
    
    return {
      company: {
        name: getFieldValue("companyName"),
        address: getFieldValue("companyAddress"),
        phone: getFieldValue("companyPhone"),
        email: getFieldValue("companyEmail")
      },
      client: {
        name: getFieldValue("clientName"),
        address: getFieldValue("clientAddress"),
        phone: getFieldValue("clientPhone"),
        email: getFieldValue("clientEmail")
      },
      logo: logoDataURL,
      invoiceNumber: getFieldValue("invoiceNumber"),
      date: getFieldValue("invoiceDate"),
      currency: getFieldValue("currency") || 'INR',
      items: items,
      taxRate: getFieldValue("taxRate") || '0',
      discountRate: getFieldValue("discountRate") || '10',
      notes: getFieldValue("notes"),
      terms: getFieldValue("terms")
    };
  } catch (e) {
    console.error('Error serializing form:', e);
    return {};
  }
}

// PREVIEW FUNCTIONS
function formatDate(dateStr) {
  try {
    if (!dateStr) return "";
    let d = new Date(dateStr);
    if (isNaN(d)) return "";
    let dd = String(d.getDate()).padStart(2, '0');
    let mmm = d.toLocaleString('en-US', { month: 'short' });
    let yyyy = d.getFullYear();
    return `${dd}-${mmm}-${yyyy}`;
  } catch (e) {
    console.error('Error formatting date:', e);
    return "";
  }
}

function previewInvoice() {
  try {
    let data = serializeForm();
    const previewBox = $("previewBox");
    const invoicePreview = $("invoicePreview");
    
    if (!previewBox || !invoicePreview) return;
    
    previewBox.style.display = "block";
    let cur = data.currency;
    let itemsRows = data.items.map(
      i => `<tr>
        <td style="padding: 8px; border-bottom: 1px solid #ddd;">${i.desc}</td>
        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${i.qty}</td>
        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${formatCurrency(i.unit, cur)}</td>
        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${formatCurrency(i.qty * i.unit, cur)}</td>
      </tr>`
    ).join("");
    
    let subtotal = data.items.reduce((a, b) => a + (parseFloat(b.qty) * parseFloat(b.unit)), 0);
    let taxAmt = subtotal * (parseFloat(data.taxRate) || 0) / 100;
    let discountAmt = (subtotal + taxAmt) * (parseFloat(data.discountRate) || 0) / 100;
    let total = subtotal + taxAmt - discountAmt;
    
    let html = `
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px;">
        <div style="flex:1;">
          <div style="font-weight:700; font-size:18px; color: var(--accent); text-transform: uppercase;">${data.company.name}</div>
          <div style="white-space: pre-line; margin: 10px 0; color: #666;">${data.company.address}</div>
          <div style="color: #666;">${data.company.phone} | ${data.company.email}</div>
        </div>
        ${data.logo ? '<img src="' + data.logo + '" style="max-height: 60px; border-radius: 4px;" />' : ""}
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
        <div style="flex:1;">
          <strong style="color: var(--accent);">Bill To:</strong><br>
          <strong>${data.client.name}</strong><br>
          ${data.client.address}<br>
          ${data.client.phone ? data.client.phone + "<br>" : ""}
          ${data.client.email ? data.client.email + "<br>" : ""}
        </div>
        <div style="text-align:right; color: #666;">
          <div><strong>Invoice #:</strong> ${data.invoiceNumber}</div>
          <div><strong>Date:</strong> ${formatDate(data.date)}</div>
          <div><strong>Currency:</strong> ${data.currency}</div>
        </div>
      </div>
      <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr style="background: var(--primary); color: white;">
          <th style="padding: 12px 8px; text-align: left;">Item</th>
          <th style="padding: 12px 8px; text-align: center;">Qty</th>
          <th style="padding: 12px 8px; text-align: right;">Unit Price</th>
          <th style="padding: 12px 8px; text-align: right;">Total</th>
        </tr>
        ${itemsRows}
      </table>
      <div style="display: flex; justify-content: flex-end; margin: 20px 0;">
        <div style="min-width: 250px;">
          <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
            <span>Subtotal:</span><span>${formatCurrency(subtotal, cur)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
            <span>Tax (${data.taxRate || 0}%):</span><span>${formatCurrency(taxAmt, cur)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
            <span>Discount (${data.discountRate || 0}%):</span><span>${formatCurrency(discountAmt, cur)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 10px 0; font-weight: 700; font-size: 16px; color: var(--accent); border-top: 2px solid var(--accent);">
            <span>Total:</span><span>${formatCurrency(Math.round(total), cur, true)}</span>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px;">
        <div style="flex: 1;"><strong>Notes:</strong><br>${data.notes || ""}</div>
        <div style="flex: 1;"><strong>Terms:</strong><br>${data.terms || ""}</div>
      </div>
    `;
    invoicePreview.innerHTML = html;
  } catch (e) {
    console.error('Error previewing invoice:', e);
    alert('‚ùå Error generating preview!');
  }
}

// PDF AND EXPORT FUNCTIONS
function generateFilename(invoiceNumber, customerName, ext) {
  try {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const min = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    const safeInvoice = (invoiceNumber || 'invoice').replace(/[^a-zA-Z0-9]/g, '_');
    const safeClient = (customerName || 'customer').replace(/[^a-zA-Z0-9]/g, '_');
    return `${safeInvoice}_${safeClient}_${yyyy}${mm}${dd}_${hh}${min}${ss}.${ext}`;
  } catch (e) {
    console.error('Error generating filename:', e);
    return `invoice_${Date.now()}.${ext}`;
  }
}

 /* function exportToJPEG() {
  try {
    const container = $("previewBox");
    if (!container || container.style.display === "none") {
      alert('Nothing to export! Please preview invoice first.');
      return;
    }
    const invoiceNumber = $("invoiceNumber")?.value || "invoice";
    const customerName = $("clientName")?.value || "customer";
    const fileName = generateFilename(invoiceNumber, customerName, "jpg");

    html2canvas  (container, {scale: 2, useCORS: true}).then(canvas => 
  {
    canvas.toBlob(blob => 
	{
      const link = document.createElement('a');
      link.download = fileName;
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
    }, 'image/jpeg', 0.9);
  }
	).catch(function(err) 
	{
        console.error('Error generating JPEG:', err);
        alert('Error generating JPEG. Please try again.');
    }
	);
  } 
  catch (e) 
  {
    console.error('Error exporting to JPEG:', e);
    alert('‚ùå Error exporting to JPEG!');
  }
}  */



function exportToJPEG() {
    const invoiceElement = document.getElementById('previewBox');
    
    // Check if preview element exists
    if (!invoiceElement) {
        alert('Preview area not found. Please check the element ID.');
        return;
    }
    
    // Check if preview has content
    if (invoiceElement.innerHTML.trim() === '<p>Click "Preview" to see your invoice here</p>' || 
        invoiceElement.innerHTML.trim() === '') {
        alert('No invoice content to export. Please generate a preview first.');
        return;
    }
    
    // Log content for debugging
    console.log('Exporting element:', invoiceElement);
    console.log('Element content:', invoiceElement.innerHTML);
    
    // Ensure element is visible before capture
    const originalDisplay = invoiceElement.style.display;
    const originalVisibility = invoiceElement.style.visibility;
    invoiceElement.style.display = 'block';
    invoiceElement.style.visibility = 'visible';
    
	const invoiceNumber = $("invoiceNumber")?.value || "invoice";
    const customerName = $("clientName")?.value || "customer";
    const fileName = generateFilename(invoiceNumber, customerName, "jpg");
	
    // Wait a moment for rendering
    setTimeout(() => {
        html2canvas(invoiceElement, {
            backgroundColor: '#ffffff',
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: true, // Enable logging for debugging
            width: invoiceElement.scrollWidth,
            height: invoiceElement.scrollHeight,
            scrollX: 0,
            scrollY: 0
        }).then(canvas => {
            // Restore original display properties
            invoiceElement.style.display = originalDisplay;
            invoiceElement.style.visibility = originalVisibility;
            
            // Check if canvas has content
            if (canvas.width === 0 || canvas.height === 0) {
                alert('Canvas is empty. Check if the element is visible.');
                return;
            }
            
            // Convert to JPEG and download
            const dataURL = canvas.toDataURL('image/jpeg', 0.95);
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('JPEG export successful');
        }).catch(error => {
            // Restore original display properties on error
            invoiceElement.style.display = originalDisplay;
            invoiceElement.style.visibility = originalVisibility;
            
            console.error('html2canvas error:', error);
            alert('Failed to export JPEG. Error: ' + error.message);
        });
    }, 100); // Small delay to ensure rendering
}


/* function exportToJPEG() { //exportJPEGAlternative
    const previewArea = document.getElementById('previewBox');
	const invoiceNumber = $("invoiceNumber")?.value || "invoice";
    const customerName = $("clientName")?.value || "customer";
    const fileName = generateFilename(invoiceNumber, customerName, "jpg");
    
    // Create canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set dimensions
    canvas.width = 800;
    canvas.height = 1000;
    
    // Set white background for JPEG
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Set text properties
    ctx.fillStyle = '#000000';
    ctx.font = '16px Arial';
    
    // Extract text content and draw on canvas
    const textContent = previewArea.innerText || previewArea.textContent;
    const lines = textContent.split('\n');
    
    let yPosition = 30;
    lines.forEach(line => {
        if (line.trim()) {
            ctx.fillText(line.trim(), 20, yPosition);
            yPosition += 25;
        }
    });
    
    // Export as JPEG
    const dataURL = canvas.toDataURL('image/jpeg', 0.95);
    
    // Create download
    const link = document.createElement('a');
    link.download = fileName;
    link.href = dataURL;
    link.click();
} */


function wrapText(str, maxLen) {
  try {
    if (!str) return '';
    let result = [];
    let line = '';
    let words = str.split(' ');
    words.forEach(word => {
      if ((line + ' ' + word).trim().length > maxLen) {
        if (line) result.push(line.trim());
        line = word;
      } else {
        line += ' ' + word;
      }
    });
    if (line) result.push(line.trim());
    return result;
  } catch (e) {
    console.error('Error wrapping text:', e);
    return [str || ''];
  }
}

function generatePDF() {
  try {
    let data = serializeForm();
    let { jsPDF } = window.jspdf;
    if (!jsPDF) {
      alert('‚ùå PDF library not loaded!');
      return;
    }
    
    let doc = new jsPDF("p", "pt", "a4");
    let pageW = doc.internal.pageSize.getWidth();
    let margin = 30;
    let y = margin + 8;
    
    if (data.logo) doc.addImage(data.logo, 'JPEG', margin, y - 5, 80, 30);
    doc.setFontSize(18);
    doc.text((data.company.name || "").toUpperCase(), data.logo ? margin + 90 : margin, y + 20);
    doc.setFontSize(10);
    
    let addressLines = (data.company.address || "").split(/\r?\n/);
    addressLines.forEach((line, idx) => {
      doc.text(line, data.logo ? margin + 90 : margin, y + 36 + idx * 14);
    });
    let addressHeight = addressLines.length * 14;
    doc.text(`${data.company.phone} | ${data.company.email}`, data.logo ? margin + 90 : margin, y + 36 + addressHeight + 10);
    y += 62 + addressHeight + 10;
    
    doc.setFontSize(11); doc.setTextColor(60);
    doc.text("Bill To:", margin, y); doc.setFont("helvetica", "bold");
    doc.text(data.client.name, margin + 48, y);
    doc.setFont("helvetica", "normal");
    
    let clientAddressY = y + 14;
    doc.text(data.client.address, margin + 48, clientAddressY);
    let nextY = clientAddressY;
    if (data.client.phone) {
      nextY += 14;
      doc.text(data.client.phone, margin + 48, nextY);
    }
    if (data.client.email) {
      nextY += 14;
      doc.text(data.client.email, margin + 48, nextY);
    }
    
    const formattedDate = formatDate(data.date);
    doc.setTextColor(80);
    doc.text(`Invoice #: ${data.invoiceNumber}`, pageW - 180, y - 50);
    doc.text(`Date: ${formattedDate}`, pageW - 180, y - 36);
    doc.text(`Currency: ${data.currency}`, pageW - 180, y - 22);
    y = nextY + 36;
    
    let itemsTable = data.items.map(i => [
      wrapText(i.desc, 48),
      i.qty,
      formatCurrency(i.unit, data.currency),
      formatCurrency(i.qty * i.unit, data.currency)
    ]);
    
    doc.autoTable({
      startY: y, margin: { left: margin, right: margin },
      head: [['Item Description', 'Qty', 'Unit Price', 'Total']],
      body: itemsTable,
      styles: { halign: 'center', valign: 'middle', fontSize: 10 },
      headStyles: { fillColor: [44, 62, 80], textColor: [255, 255, 255] },
      alternateRowStyles: { fillColor: [248, 250, 252] },
      columnStyles: { 0: { halign: 'left', cellWidth: 180 } },
      theme: 'grid'
    });
    y = doc.lastAutoTable.finalY + 15;
    
    let subtotal = data.items.reduce((a, b) => a + (parseFloat(b.qty) * parseFloat(b.unit)), 0);
    let taxAmt = subtotal * (parseFloat(data.taxRate) || 0) / 100;
    let discountAmt = (subtotal + taxAmt) * (parseFloat(data.discountRate) || 0) / 100;
    let total = subtotal + taxAmt - discountAmt;
    
    let summaryTable = [
      ['Subtotal', formatCurrency(subtotal, data.currency)],
      [`Tax (${data.taxRate || 0}%)`, formatCurrency(taxAmt, data.currency)],
      [`Discount (${data.discountRate || 0}%)`, formatCurrency(discountAmt, data.currency)],
      ['Total', formatCurrency(Math.round(total), data.currency, true)]
    ];
    
    doc.autoTable({
      startY: y,
      margin: { left: pageW - 300 },
      head: [['Total', 'Value']],
      body: summaryTable,
      styles: { fontSize: 10, halign: 'left' },
      columnStyles: { 0: { halign: 'left', cellWidth: 100 }, 1: { halign: 'left', cellWidth: 90 } },
      theme: 'grid',
      tableWidth: 280,
      headStyles: { fillColor: [230, 126, 34], textColor: [255, 255, 255] }
    });
    y = doc.lastAutoTable.finalY + 18;
    
    doc.setFontSize(10); doc.setTextColor(120);
    doc.text("Notes: " + (data.notes || ""), margin, y);
    y += 14;
    doc.text("Terms: " + (data.terms || ""), margin, y);
    
    const fileName = generateFilename(data.invoiceNumber, data.client.name, "pdf");
    doc.save(fileName);
    saveInvoiceToHistory(data);
  } catch (e) {
    console.error('Error generating PDF:', e);
    alert('‚ùå Error generating PDF!');
  }
}

// COMPACT HISTORY FUNCTIONS
function loadHistory() {
  try {
    let ul = $("invoiceHistory");
    if (!ul) return;
    
    let list = JSON.parse(localStorage.getItem("invoice_history") || "[]");
    let reversed = list.slice().reverse();
    ul.innerHTML = reversed.length ? "" : '<li class="history-item"><div class="history-item-info">No invoices.</div></li>';
    
    reversed.forEach((inv, ix) => {
      let origIdx = list.length - 1 - ix;
      let li = document.createElement("li");
      li.className = "history-item";
      li.innerHTML = `
        <div class="history-item-info">
          <div class="history-item-number">${inv.invoiceNumber}</div>
          <div class="history-item-details">${inv.client.name} ‚Ä¢ ${inv.date || 'No date'}</div>
        </div>
        <div class="history-actions">
          <button type="button" class="btn btn-success btn-sm" onclick="fillFormFromHistory(${origIdx})">üìÇ Load</button>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeHistoryEntry(${origIdx})">üóëÔ∏è Remove</button>
        </div>
      `;
      ul.appendChild(li);
    });
  } catch (e) {
    console.error('Error loading history:', e);
  }
}

function saveInvoiceToHistory(data) {
  try {
    let list = JSON.parse(localStorage.getItem("invoice_history") || "[]");
    let idx = list.findIndex(i => i.invoiceNumber === data.invoiceNumber);
    if (idx > -1) list[idx] = data; else list.push(data);
    localStorage.setItem("invoice_history", JSON.stringify(list));
    loadHistory();
  } catch (e) {
    console.error('Error saving to history:', e);
  }
}

function fillFormFromHistory(idx) {
  try {
    let list = JSON.parse(localStorage.getItem("invoice_history") || "[]");
    let data = list[idx];
    if (!data) return;
    
    const fieldMappings = [
      ['companyName', data.company?.name],
      ['companyAddress', data.company?.address],
      ['companyPhone', data.company?.phone],
      ['companyEmail', data.company?.email],
      ['clientName', data.client?.name],
      ['clientAddress', data.client?.address],
      ['clientPhone', data.client?.phone],
      ['clientEmail', data.client?.email],
      ['invoiceNumber', data.invoiceNumber],
      ['invoiceDate', data.date],
      ['currency', data.currency],
      ['taxRate', data.taxRate],
      ['discountRate', data.discountRate],
      ['notes', data.notes],
      ['terms', data.terms]
    ];
    
    fieldMappings.forEach(([fieldId, value]) => {
      const field = $(fieldId);
      if (field && value !== undefined) {
        field.value = value || "";
      }
    });
    
    currency = data.currency || "INR";
    
    logoDataURL = data.logo || "";
    const logoPreview = $("logoPreview");
    if (logoPreview) {
      logoPreview.src = logoDataURL || "";
      logoPreview.style.display = logoDataURL ? "block" : "none";
    }
    
    const tbody = $("itemsBody");
    if (tbody) {
      tbody.innerHTML = "";
      (data.items || []).forEach(i => addItemRow(i));
    }
    
    updateTotals();
    previewInvoice();
    window.scrollTo(0, 0);
  } catch (e) {
    console.error('Error filling form from history:', e);
  }
}

function removeHistoryEntry(idx) {
  try {
    let list = JSON.parse(localStorage.getItem("invoice_history") || "[]");
    if (!confirm(`Remove invoice "${list[idx]?.invoiceNumber}"?`)) return;
    list.splice(idx, 1);
    localStorage.setItem("invoice_history", JSON.stringify(list));
    loadHistory();
  } catch (e) {
    console.error('Error removing history entry:', e);
  }
}

// COMPACT INVOICE MASTER FUNCTIONS
function saveInvoiceToMaster() {
  try {
    const invoiceData = serializeForm();
    
    if (!invoiceData.invoiceNumber || !invoiceData.client.name) {
      alert("‚ùå Invoice number and client name are required!");
      return;
    }
    
    let invoiceMaster = JSON.parse(localStorage.getItem('invoice_master') || '[]');
    
    const existingIndex = invoiceMaster.findIndex(inv => inv.invoiceNumber === invoiceData.invoiceNumber);
    
    if (existingIndex !== -1) {
      if (confirm(`Invoice ${invoiceData.invoiceNumber} already exists. Update it?`)) {
        invoiceMaster[existingIndex] = invoiceData;
        alert(`‚úÖ Invoice ${invoiceData.invoiceNumber} updated in master!`);
      } else {
        return;
      }
    } else {
      invoiceMaster.push(invoiceData);
      alert(`‚úÖ Invoice ${invoiceData.invoiceNumber} saved to master!\nTotal invoices: ${invoiceMaster.length}`);
    }
    
    localStorage.setItem('invoice_master', JSON.stringify(invoiceMaster));
    loadInvoiceMasterList();
  } catch (e) {
    console.error('Error saving invoice to master:', e);
    alert('‚ùå Error saving invoice to master!');
  }
}

function loadInvoiceMasterList() {
  try {
    const invoiceMaster = JSON.parse(localStorage.getItem('invoice_master') || '[]');
    const ul = $("invoiceMasterList");
    
    if (!ul) return;
    
    ul.innerHTML = "";
    
    if (invoiceMaster.length === 0) {
      ul.innerHTML = '<li class="history-item"><div class="history-item-info">No invoices in master file.</div></li>';
      return;
    }
    
    invoiceMaster.reverse().forEach((invoice, index) => {
      const originalIndex = invoiceMaster.length - 1 - index;
      const li = document.createElement("li");
      li.className = "history-item";
      li.innerHTML = `
        <div class="history-item-info">
          <div class="history-item-number">${invoice.invoiceNumber}</div>
          <div class="history-item-details">${invoice.client.name} ‚Ä¢ ${invoice.date || 'No date'}</div>
        </div>
        <div class="history-actions">
          <button type="button" class="btn btn-success btn-sm" onclick="loadInvoiceFromMaster(${originalIndex})">üìÇ Load</button>
          <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceFromMaster(${originalIndex})">üóëÔ∏è Remove</button>
        </div>
      `;
      ul.appendChild(li);
    });
  } catch (e) {
    console.error('Error loading invoice master list:', e);
  }
}

function loadInvoiceFromMaster(index) {
  try {
    const invoiceMaster = JSON.parse(localStorage.getItem('invoice_master') || '[]');
    const invoice = invoiceMaster[index];
    
    if (!invoice) {
      alert("‚ùå Invoice not found!");
      return;
    }
    
    if (!confirm(`Load invoice ${invoice.invoiceNumber}?\n\nThis will replace current form data.`)) {
      return;
    }
    
    const fieldMappings = [
      ['companyName', invoice.company?.name],
      ['companyAddress', invoice.company?.address],
      ['companyPhone', invoice.company?.phone],
      ['companyEmail', invoice.company?.email],
      ['clientName', invoice.client?.name],
      ['clientAddress', invoice.client?.address],
      ['clientPhone', invoice.client?.phone],
      ['clientEmail', invoice.client?.email],
      ['invoiceNumber', invoice.invoiceNumber],
      ['invoiceDate', invoice.date],
      ['currency', invoice.currency],
      ['taxRate', invoice.taxRate],
      ['discountRate', invoice.discountRate],
      ['notes', invoice.notes],
      ['terms', invoice.terms]
    ];
    
    fieldMappings.forEach(([fieldId, value]) => {
      const field = $(fieldId);
      if (field && value !== undefined) {
        field.value = value || "";
      }
    });
    
    currency = invoice.currency || "INR";
    
    logoDataURL = invoice.logo || "";
    const logoPreview = $("logoPreview");
    if (logoPreview) {
      if (logoDataURL) {
        logoPreview.src = logoDataURL;
        logoPreview.style.display = "block";
      } else {
        logoPreview.style.display = "none";
      }
    }
    
    const tbody = $("itemsBody");
    if (tbody) {
      tbody.innerHTML = "";
      if (invoice.items && invoice.items.length > 0) {
        invoice.items.forEach(item => addItemRow(item));
      } else {
        addItemRow();
      }
    }
    
    updateTotals();
    alert(`‚úÖ Invoice ${invoice.invoiceNumber} loaded successfully!`);
  } catch (e) {
    console.error('Error loading invoice from master:', e);
    alert('‚ùå Error loading invoice!');
  }
}

function removeInvoiceFromMaster(index) {
  try {
    const invoiceMaster = JSON.parse(localStorage.getItem('invoice_master') || '[]');
    const invoice = invoiceMaster[index];
    
    if (!invoice) {
      alert("‚ùå Invoice not found!");
      return;
    }
    
    if (!confirm(`Remove invoice ${invoice.invoiceNumber} from master?\n\nThis cannot be undone.`)) {
      return;
    }
    
    invoiceMaster.splice(index, 1);
    localStorage.setItem('invoice_master', JSON.stringify(invoiceMaster));
    loadInvoiceMasterList();
    
    alert(`‚úÖ Invoice ${invoice.invoiceNumber} removed from master!`);
  } catch (e) {
    console.error('Error removing invoice from master:', e);
    alert('‚ùå Error removing invoice!');
  }
}

// OTHER FUNCTIONS
function saveDraft() {
  try {
    let data = serializeForm();
    localStorage.setItem("invoice_draft", JSON.stringify(data));
    alert("‚úÖ Invoice draft saved!");
  } catch (e) {
    console.error('Error saving draft:', e);
    alert('‚ùå Error saving draft!');
  }
}

function loadDraft() {
  try {
    let d = JSON.parse(localStorage.getItem("invoice_draft") || "null");
    if (d) {
      const fieldMappings = [
        ['companyName', d.company?.name],
        ['companyAddress', d.company?.address],
        ['companyPhone', d.company?.phone],
        ['companyEmail', d.company?.email],
        ['clientName', d.client?.name],
        ['clientAddress', d.client?.address],
        ['clientPhone', d.client?.phone],
        ['clientEmail', d.client?.email],
        ['invoiceNumber', d.invoiceNumber],
        ['invoiceDate', d.date],
        ['currency', d.currency],
        ['taxRate', d.taxRate],
        ['discountRate', d.discountRate],
        ['notes', d.notes],
        ['terms', d.terms]
      ];
      
      fieldMappings.forEach(([fieldId, value]) => {
        const field = $(fieldId);
        if (field && value !== undefined) {
          field.value = value || "";
        }
      });
      
      currency = d.currency || "INR";
      logoDataURL = d.logo || "";
      
      const tbody = $("itemsBody");
      if (tbody) {
        tbody.innerHTML = "";
        (d.items || []).forEach(i => addItemRow(i));
      }
      
      updateTotals();
    }
  } catch (e) {
    console.error('Error loading draft:', e);
  }
}

function clearForm() {
  try {
    if (!confirm("Clear all invoice data?")) return;
    
    const fieldDefaults = [
      ['companyName', 'G3 Beauty Lounge'],
      ['companyAddress', '5/432, 2nd Cross, Sairam Nagar,\nNear Best Writing Institute,\nMedavakkam, Chennai 600100'],
      ['companyPhone', 'PH:7904081684'],
      ['companyEmail', 'Email: g3beautylounge@gmail.com'],
      ['clientName', ''],
      ['clientAddress', ''],
      ['clientPhone', ''],
      ['clientEmail', ''],
      ['currency', 'INR'],
      ['taxRate', '0'],
      ['discountRate', '10'],
      ['notes', 'UPI and CASH accepted. Thank you for your business! Get Extra 5% for referrals'],
      ['terms', 'All services are non-refundable.']
    ];
    
    fieldDefaults.forEach(([fieldId, value]) => {
      const field = $(fieldId);
      if (field) field.value = value;
    });
    
    const searchInput = $("customerSearchInput");
    if (searchInput) searchInput.value = "";
    
    const lovDropdown = $("lovDropdown");
    if (lovDropdown) lovDropdown.style.display = "none";
    
    const clientDropdown = $("clientNameDropdown");
    if (clientDropdown) clientDropdown.style.display = "none";
    
    setInvoiceDefaults();
    currency = "INR";
    logoDataURL = "";
    
    const logoPreview = $("logoPreview");
    if (logoPreview) {
      logoPreview.src = "";
      logoPreview.style.display = "none";
    }
    
    const tbody = $("itemsBody");
    if (tbody) {
      tbody.innerHTML = "";
      addItemRow();
    }
    
  } catch (e) {
    console.error('Error clearing form:', e);
  }
}

// EVENT LISTENERS SETUP
function setupEventListeners() {
  try {
    const currencySelect = $("currency");
    if (currencySelect) {
      currencySelect.addEventListener("change", function() {
        currency = this.value;
        updateTotals();
      });
    }

    ["taxRate", "discountRate"].forEach(id => {
      const field = $(id);
      if (field) {
        field.addEventListener("input", updateTotals);
      }
    });

    const logoUpload = $("logoUpload");
    if (logoUpload) {
      logoUpload.addEventListener("change", function(event) {
        let file = event.target.files[0];
        if (!file) return;
        if (!file.type.startsWith("image/")) {
          alert("Logo must be an image.");
          return;
        }
        if (file.size > 204800) {
          alert("Logo must be below 200KB.");
          this.value = "";
          return;
        }
        let reader = new FileReader();
        reader.onload = function(e) {
          logoDataURL = e.target.result;
          const logoPreview = $("logoPreview");
          if (logoPreview) {
            logoPreview.src = logoDataURL;
            logoPreview.style.display = "block";
          }
        };
        reader.readAsDataURL(file);
      });
    }

    const invoiceForm = $("invoiceForm");
    if (invoiceForm) {
      invoiceForm.onsubmit = (e) => e.preventDefault();
    }

    const itemsBody = $("itemsBody");
    if (itemsBody) {
      itemsBody.addEventListener("input", updateTotals);
    }

    ["companyName", "companyAddress", "companyPhone", "companyEmail", 
     "clientName", "clientAddress", "clientPhone", "clientEmail", 
     "invoiceNumber", "invoiceDate", "currency", "taxRate", "discountRate", 
     "notes", "terms"].forEach(id => {
      const field = $(id);
      if (field) {
        field.addEventListener("input", updateTotals);
      }
    });
  } catch (e) {
    console.error('Error setting up event listeners:', e);
  }
}

// MAIN INITIALIZATION
function initializeApp() {
  try {
    console.log('üöÄ Initializing Invoice Generator...');
    
    clearCustomerDataOnLoad();
    setInvoiceDefaults();
    initializeItemsTable();
    setupCustomerSearch();
    updateCustomerMasterCount();
    loadHistory();
    loadDraft();
    loadInvoiceMasterList();
    setupEventListeners();
    
    console.log('‚úÖ App initialized successfully');
  } catch (e) {
    console.error('‚ùå Error initializing app:', e);
  }
}

// APP STARTUP
window.onload = function() {
  console.log('üîÑ App loading - Clearing customer data...');
  clearCustomerDataOnLoad();
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
};
</script>
</body>
</html>

